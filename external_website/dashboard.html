<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="./css/formcss.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <!--https://codepen.io/mican/pen/dRWxZe-->
    <!-- jQuery: required (tablesorter works with jQuery 1.2.3+) -->
    <script src="./js/tablesorter/docs/js/jquery-1.2.6.min.js"></script>
    <!-- Pick a theme, load the plugin & initialize plugin -->
    <link href="./js/tablesorter/dist/css/theme.bootstrap_4.min.css" rel="stylesheet">
    <script src="./js/tablesorter/dist/js/jquery.tablesorter.min.js"></script>
    <script src="./js/tablesorter/dist/js/jquery.tablesorter.widgets.min.js"></script>

    <script src="./js/dashboard/request.js"></script>
    <script src="./js/dashboard/generate_table.js"></script>
    <script src="./js/dashboard/generate_freezers.js"></script>
    <title>Dashboard</title>
    <style>
        th {
            padding: 20px;
        }

        td {
            padding-left: 20px;
            padding-right: 20px;
        }

        h2,
        h3 {
            text-align: center;
            margin: 40px;
        }
    </style>
</head>

<body>
    <div class="container">
        <form method="POST" name="get_token" action="javascript:void(0);" onsubmit="setToken()">
            <input type="text" name="token" class="form-control" placeholder="insert your token" required>
            <button type="submit" name="submit" class="btn btn-primary">Submit</button>
        </form>
        <p id="token_error"></p>
        <h2>Possible types</h2>
        <div id="types_table">
        </div>

        <div>
            <h2>Freezers</h2>
            <div id="freezers_table"></div>
            <h3>Add a freezer</h3>
            <form method="POST" name="add_freezer" action="javascript:void(0);" onsubmit="addFreezer('add_freezer')">
                <div class="row">
                    <div class="col-md-6">
                        <input type="text" name="name" class="form-control " placeholder="freezer name" required>
                    </div>
                    <div class="col-md-6">
                        <input type="text" name="num_boxes" class="form-control" placeholder="number of boxes" required>
                    </div>
                </div>
                <input class="btn btn-primary" type="submit" name="submit">
            </form>
        </div>
        <div>
            <h2>Products</h2>
            <div id="products_listing" class="custom-control custom-radio"></div>
            <div id="products_table"></div>
            <form method="POST" name="add_product" class="form" action="javascript:void(0);" onsubmit="addProduct()">
                <div class="row">
                    <div class="col-md-6">
                        <input type="text" name="product_name" class="form-control" placeholder="product_name" required>
                    </div>
                    <div class="col-md-6">
                        <input type="text" name="text_descr" class="form-control" placeholder="product description" required>
                    </div>
                    <div class="col-md-6">
                        <select type="select" id="freezer_id_form" name="freezer_id" class="form-control"></select>
                    </div>
                    <div class="col-md-6">
                        <select type="select" id="type_id_form" name="type_id" class="form-control"></select>
                    </div>
                    <div class="col-md-6">
                        <input type="datetime-local" pattern="[0-9]{4}-[0-9]{2}-[0-9]{2}" name="date_in" class="form-control" placeholder="2018-15-03"
                            required>
                    </div>
                    <div class="col-md-6">
                        <input type="text" name="period" class="form-control" placeholder="period in month" required>
                    </div>
                    <div class="col-md-6">
                        <input type="number" name="box_num" class="form-control" placeholder="box number" required>
                    </div>
                    <div class="col-md-6">
                        <input type="number" name="prod_num" class="form-control" placeholder="product number" required>
                    </div>
                    <div class="col-md-6">
                        <input type="number" name="quantity" class="form-control" placeholder="quantity" required>
                    </div>
                </div>

                <input class="button" type="submit" name="submit">
            </form>
        </div>
    </div>

</body>
<script>
    var token = "";
    var domainUrl = "http://localhost:5000/";
    var typesObject = {};
    var freezersObject = {};

    function setToken() {
        token = document.forms["get_token"]["token"].value;
        check_token();
    }

    function clear_dashboard() {
        document.getElementById("token_error").innerHTML = "";
        document.getElementById("types_table").innerHTML = "";
        document.getElementById("freezers_table").innerHTML = "";
        document.getElementById("products_listing").innerHTML = "";
        document.getElementById("products_table").innerHTML = "";
    }

    function setTypesChoices(objectIdentifier) {
        var select, i, option;
        select = document.getElementById(objectIdentifier);
        //Clean up the type_id tag
        var selectParentNode = select.parentNode;
        var newSelectObj = select.cloneNode(false); // Make a shallow copy
        selectParentNode.replaceChild(newSelectObj, select);
        select = newSelectObj

        for (var i = 0; i < typesObject.content.length; i++) {
            option = document.createElement('option');
            option.value =  typesObject.content[i]['type_id'];
            option.text = typesObject.content[i]['type_name_en'];
            select.add(option);
        }
    }

    function setFreezersChoices(objectIdentifier) {
        var select, i, option;
        select = document.getElementById(objectIdentifier);
        //Clean up the type_id tag
        var selectParentNode = select.parentNode;
        var newSelectObj = select.cloneNode(false); // Make a shallow copy
        selectParentNode.replaceChild(newSelectObj, select);
        select = newSelectObj

        for (var i = 0; i < freezersObject.content.length; i++) {
            option = document.createElement('option');
            option.value = freezersObject.content[i]['freezer_id'];
            option.text = freezersObject.content[i]['freezer_name'];
            select.add(option);
        }
    }

    function check_token() {
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                clear_dashboard();
                setDashboard();
            } else {
                clear_dashboard();
                document.getElementById("token_error").innerHTML = "the token given is not valid";
            }
            // need to manage other types exception
        };
        xmlhttp.open("GET", "http://localhost:5000/check_token/" + token, true);
        xmlhttp.send();
    }

    function generateProductStuffs() {
        generateProductSelection('products_listing');
        setFreezersChoices('freezer_id_form');
        setTypesChoices('type_id_form');
    }

    function setDashboard() {
        typesObject = {
            type: "GET",
            url: domainUrl + "types/" + token,
            elementId: "types_table"
        };

        freezersObject = {
            type: "GET",
            url: domainUrl + "freezers/" + token,
            elementId: "freezers_table",
            cascadeCallback: true,
            callback: generateProductStuffs,
            callbackParams: ""
        };

        ajaxRequest(typesObject, generateTableFromJson);
        ajaxRequest(freezersObject, generateTableFromJson);
        console.log(freezersObject);
    }

    function addProduct() {
        var length = document.forms["add_product"].length;
        var data = document.forms["add_product"].elements;
        var my_test = {};
        for (i = 0; i < length; i++) {
            if (data[i].name != 'submit') {
                my_test[data[i].name] = data[i].value;
            }
        }
        //Send my_test to ajaxRequest
        product = {
            type: "POST",
            url: domainUrl +"add_product/" + token,
            toSend: my_test
        }
        console.log(product);
        ajaxRequest(product);
    }
</script>

</html>